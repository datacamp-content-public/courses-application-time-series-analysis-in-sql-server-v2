---
title: Insert title here
key: 01dfaaa04b102f8161a3888ed2cc070d

---
## Computing simple arithmetic moving averages

```yaml
type: "TitleSlide"
key: "332887d866"
```

`@lower_third`

name: James Wang
title: Data Scientist


`@script`
We will be computing moving averages for numerical time series data sets. Moving averages are fundamental to analysing past trends and patterns to help with decision making going forward into the future. At the end of the lesson we will be able to split time series data into granular periods, compute moving averages for any time lag to get a good understanding of past data trends.


---
## Setting up the date parameters of the data set

```yaml
type: "FullCodeSlide"
key: "a775f65724"
```

`@part1`
```
select 
year(date) as Y, month(date) as M, day(date) as D, *  
from dbo.data

```


`@script`
We numerical data for an entire year but the date is in the format yymmdd. We want to add year month day fields to the data as a first step so we can utilise the additional information to pinpoint the time series data we would like to work with at ease. We use the date, month and date functions to create additional columns to the time series data set. When this is run you can see that the extra columns will appear, which will allow us to create moving averages of the numerical information down the track by grouping by year, month or day.


---
## Creating row numbers

```yaml
type: "FullCodeSlide"
key: "2faa157ac2"
```

`@part1`
```
select a.*, row_number() over (partition by y order by y) as RowNumber
	from
	(
		select 
		year(date) as Y, 
                month(date) as M, 
                day(date) as D, *  
		from dbo.data
	) A
```


`@script`
To calculate moving averages we need a way to reference data going back in time. For example, for a 10 day moving average we need to get the data for the past 10 days inclusive of the current day. How do we do this? We need to create row numbers in ascending order and then reference back the number of time lags to obtain the moving average. In this step we use the row_number() function to create a row column as a reference point for time. How far back in time we need to go can be determined from this reference point for calculation of moving averages. 
Our data is for an entire year, or 365 days. We partition by year and order it by year to create a row column in ascending order for the entire year. This then can be used in the next step, to calculate moving averages based on a predefined time lag.


---
## Putting it all together to create moving averages

```yaml
type: "FullCodeSlide"
key: "a55c9c60c2"
```

`@part1`
'''

select b.*, case when RowNumber>9 then avg(b.bank_account_balance) over (order by b.RowNumber rows 9 preceding) end as MACash10, 
case when rownumber>19 then avg(b.bank_account_balance) over (order by b.rownumber rows 19 preceding) end as MACash20
from
(
	select a.*, row_number() over (partition by y order by y) as RowNumber
	from
	(
		select 
		year(date) as Y, month(date) as M, day(date) as D, *  
		from dbo.data
	) A
) B


'''


`@script`
We will create moving averages of 10 and 20 using the time period reference period column we created in the previous slide. To do this, we create an outer nested query to make full use of the work we did in the past. 

We will create 2 new columns, 1 for 10 day moving average, 1 for 20 day moving average. 

In one single SQL block we will create the moving average and ensure if only calculates if there is enough data going back in time to calculate that moving average. 

```
case when RowNumber>9 then avg(b.bank_account_balance) over (order by b.RowNumber rows 9 preceding) end as MACash10 
```

The first code block uses the row number column and gives us the moving average of the past 10 time series data points and ignores the calculation if there is less than 10 data points, ignoring the first 9 instances where there is not enough data to compute. This is controlled by the case when statement. 

We use the average statement over rows preceding to compute this calculation. 

Similarly we can apply this calculation for a 20 day moving average and so on and so forth.

When the entire code block is run, we have our 2 new columns of moving average data side by side.


---
## Lesson Summary

```yaml
type: "FinalSlide"
key: "9f4dc1d849"
```

`@script`
To recap, in this lesson we have learned to strip out date information to be able to isolate certain times of the year using Year() Month() Date() functions.

Then we created row numbers for our time series data using the Row_Number() function. 

Finally we learned to create 10 and 20 day moving averages using the Order By Rows Preceding function.

